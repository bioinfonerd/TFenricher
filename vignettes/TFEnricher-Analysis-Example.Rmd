---
title: "TFEnricher-Analysis-Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r Load In Libraries}
#load all required libraries
#library(TFenricher)
#load all required libraries
#list.of.packages <- c("indRa","limma","tidyverse","EBSeq","edgeR","stringr","tibble","readr",'BiocManager','DESeq2',"dplyr","tximport","tximportData","pasilla","IHW","tidyr", "fgsea","ggplot2","GSA","stats","reticulate","synapser","synExtra")
#suppressMessages(lapply(list.of.packages, require, character.only = TRUE))
#install.packages("synapser", repos=c("http://ran.synapse.org", "http://cran.fhcrc.org"))
library(DESeq2)
library(tidyverse)
#install.packages("remotes")
#remotes::install_github("ArtemSokolov/synExtra")
#until build reflects functions loaded
devtools::load_all()
#[TODO]: Fix why this shows up "Welcome, Nathan Johnson!"
#set working directory
setwd("C:/Users/Nathan/Documents/@Harvard/Artem/Transcription_Factor_Analysis/git/TFenricher/vignettes")


```

```{r DESeq2 run all conditions DGE}
DESeq2_run_all('JAK2')
DESeq2_run_all('SIK3')
DESeq2_run_all('PRKCE')
```
```{r Run all conditions for GSEA analysis}


```

```{r DESeq2 Differential Gene Expression Analysis (DGE)}
#DESeq2
#count table, meta table, drug to target on
DESeq2_run(count_file='DGE1_DGE2_counts',
           meta_file='DGE1_DGE2_meta',
           target='SIK3')
#DESeq2_run('DGE1_DGE2_counts','DGE1_DGE2_meta',target='SIK3')
#DESeq2_run('DGE1_DGE2_counts','DGE1_DGE2_meta',target='PRKCE')

```

```{r EdgeR DGE}
#EdgeR
edgeR_JAK2<-edgeR_run(count_file_name='DGE1_DGE2_counts',
          meta_file_name='DGE1_DGE2_meta',
          target='JAK2')



#edgeR_run('DGE1_DGE2_counts','DGE1_DGE2_meta',target='SIK3')
#edgeR_run('DGE1_DGE2_counts','DGE1_DGE2_meta',target='PRKCE')

```

```{r DGE Test}
#Nathan's DGE Results For JAK2 Target
edgeR_JAK2<-read_tsv('../Results/Differential_Gene_Analysis/EdgeR/JAK2_DGE1_DGE2_meta_EdgeR.tsv')
#DESeq2_JAK2<-read_tsv('../Results/Differential_Gene_Analysis/DESeq2/JAK2_DGE1_DGE2_meta_DESeq2.tsv')

#

#conclusion: different statistical analysis 



```

```{r edgeR top 10 results}
edgeR_JAK2 %>% arrange(FDR) %>% head()

edgeR_JAK2 %>% filter(Gene=='CXCL8')
```

```{r TF GSEA Analysis}
# TF GSEA Analysis --------------------------------------------------------
#Rank GSEA Analysis for DESeq2 OR EdgeR & P Adjusted Analysis
#somtimes an error: 'package:stats' not available when loading, weird Rstudio bug that restarting Rstudio seems to fix

rank_GSEA_single(file='JAK2_DGE1_DGE2_meta_EdgeR',
                 method_input='EdgeR',
                 gmt='all_plusISG.gmt')
```

```{r Running glm vs qlm edgeR TF GSEA analysis}

#glmLRT (JAK2 verification test)
JAK2_TF_glm<-rank_GSEA_single(file='JAK2_DGE1_DGE2_meta_glmFit_EdgeR',
                 method_input='EdgeR',
                 gmt='all_plusISG.gmt')
JAK2_TF_qlm<-rank_GSEA_single(file='JAK2_DGE1_DGE2_meta_qlmFit_EdgeR',
                 method_input='EdgeR',
                 gmt='all_plusISG.gmt')
```

```{r compare}
JAK2_TF_glm %>% arrange(padj) %>% head()
JAK2_TF_qlm %>% arrange(padj) %>% head()
```

``` {r TF Expression Visualization EdgeR}
# TF Expression Visualiation ----------------------------------------------
image = TF_enriched_targets_Violin_Plot(GSEA_result='JAK2_DGE1_DGE2_meta_qlmFit_EdgeRall_plusISG.gmtEdgeR.p_adjusted',
                                count_file_name='DGE1_DGE2_counts',
                                meta_file_name='DGE1_DGE2_meta',
                                TF_name='FOS',
                                DGA_method='EdgeR',
                                DGA_file='JAK2_DGE1_DGE2_meta_qlmFit_EdgeR')

```

```{r DESeq2 GSEA}

rank_GSEA_single(file='JAK2_DGE1_DGE2_meta_DESeq2',
                 method_input='DESeq2',
                 gmt='all_plusISG.gmt',
                 type_input='p_adjusted')

```

```{r Load In GSEA Results}

df <- read_tsv(paste('../Results/Gene_Set_Enrichment_Analysis/DESeq2/'
                     ,'JAK2_DGE1_DGE2_meta_DESeq2all_plusISG.gmtDESeq2.p_adjusted','.tsv',sep=""))
df %>% arrange(padj)

```

```{r TF Visualization DESeq2}
image = TF_enriched_targets_Violin_Plot(GSEA_result_loc='../Results/Gene_Set_Enrichment_Analysis/DESeq2/',
                                GSEA_result='JAK2_DGE1_DGE2_meta_DESeq2all_plusISG.gmtDESeq2.p_adjusted',
                                count_file_name='DGE1_DGE2_counts',
                                meta_file_name='DGE1_DGE2_meta',
                                TF_name='PPARG',
                                DGA_method='DESeq2',
                                DGA_file='JAK2_DGE1_DGE2_meta_DESeq2')
image

```
